
// ê¸°ë³¸ ë‹¨ê°€ ì„¤ì • (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©)
let pricing = {
    demolition: 50000,    // ì² ê±° (í‰ë‹¹)
    carpentry: 80000,     // ëª©ê³µ (í‰ë‹¹)
    electrical: 60000,    // ì „ê¸°ê³µì‚¬ (í‰ë‹¹)
    wallpaper: 120000,    // ë„ë°° (ê°œë‹¹)
    window: 250000,       // ìƒ·ì‹œ (ê°œë‹¹)
    lighting: 45000,      // ì¡°ëª… (ê°œë‹¹)
    molding: 8000,        // ëª°ë”© (ë¯¸í„°ë‹¹)
    flooring: 70000,      // ë°”ë‹¥ì¬ (í‰ë‹¹)
    door: 180000,         // ë¬¸êµì²´ (ê°œë‹¹)
    bathroom: 800000,     // ìš•ì‹¤ (ê°œë‹¹)
    aircon: 350000,       // ì—ì–´ì»¨ (ê°œë‹¹)
    facility: 150000,     // ì„¤ë¹„ (ê°œë‹¹)
    island: 200000,       // ì„¬ ê³µì‚¬ (ì¼ë‹¹)
    labor: 100000         // ê¸°ë³¸ ì¸ê±´ë¹„ (ì¼ë‹¹)
};

// ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ê¸°ë³¸ê°’ ì‚¬ìš©)
let adminPassword = localStorage.getItem('adminPassword') || '1234';

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    loadPricing();
    loadAdminPricing();
    setupEventListeners();
    calculateEstimate();
});

// ì €ì¥ëœ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ê¸°
function loadPricing() {
    const savedPricing = localStorage.getItem('interiorPricing');
    if (savedPricing) {
        pricing = JSON.parse(savedPricing);
    }
}

// ê´€ë¦¬ì íŒ¨ë„ì— í˜„ì¬ ë‹¨ê°€ ë¡œë“œ
function loadAdminPricing() {
    document.getElementById('admin-demolition').value = pricing.demolition;
    document.getElementById('admin-carpentry').value = pricing.carpentry;
    document.getElementById('admin-electrical').value = pricing.electrical;
    document.getElementById('admin-wallpaper').value = pricing.wallpaper;
    document.getElementById('admin-window').value = pricing.window;
    document.getElementById('admin-lighting').value = pricing.lighting;
    document.getElementById('admin-molding').value = pricing.molding;
    document.getElementById('admin-flooring').value = pricing.flooring;
    document.getElementById('admin-door').value = pricing.door;
    document.getElementById('admin-bathroom').value = pricing.bathroom;
    document.getElementById('admin-aircon').value = pricing.aircon;
    document.getElementById('admin-facility').value = pricing.facility;
    document.getElementById('admin-island').value = pricing.island;
    document.getElementById('admin-labor').value = pricing.labor;
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ê³„ì‚°
    const inputs = document.querySelectorAll('.form-input');
    inputs.forEach(input => {
        input.addEventListener('input', calculateEstimate);
    });

    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
    document.getElementById('islandWork').addEventListener('change', function() {
        const islandDaysInput = document.getElementById('islandDays');
        islandDaysInput.disabled = !this.checked;
        if (!this.checked) {
            islandDaysInput.value = 0;
        }
        calculateEstimate();
    });

    document.getElementById('includeLaborCost').addEventListener('change', calculateEstimate);

    // ê´€ë¦¬ì ëª¨ë“œ ë²„íŠ¼
    document.getElementById('adminBtn').addEventListener('click', openAdminPanel);
    document.getElementById('closeAdminBtn').addEventListener('click', closeAdminPanel);
    document.getElementById('saveBtn').addEventListener('click', savePricing);
    document.getElementById('changePasswordBtn').addEventListener('click', changePassword);

    // ì•¡ì…˜ ë²„íŠ¼ë“¤
    document.getElementById('copyBtn').addEventListener('click', copyEstimate);
    document.getElementById('printBtn').addEventListener('click', printEstimate);
}

// ê²¬ì  ê³„ì‚° í•¨ìˆ˜
function calculateEstimate() {
    const workDays = parseFloat(document.getElementById('workDays').value) || 0;
    
    // ê° í•­ëª©ë³„ ìˆ˜ëŸ‰ ê°€ì ¸ì˜¤ê¸°
    const quantities = {
        demolition: parseFloat(document.getElementById('demolition').value) || 0,
        carpentry: parseFloat(document.getElementById('carpentry').value) || 0,
        electrical: parseFloat(document.getElementById('electrical').value) || 0,
        wallpaper: parseFloat(document.getElementById('wallpaper').value) || 0,
        window: parseFloat(document.getElementById('window').value) || 0,
        lighting: parseFloat(document.getElementById('lighting').value) || 0,
        molding: parseFloat(document.getElementById('molding').value) || 0,
        flooring: parseFloat(document.getElementById('flooring').value) || 0,
        door: parseFloat(document.getElementById('door').value) || 0,
        bathroom: parseFloat(document.getElementById('bathroom').value) || 0,
        aircon: parseFloat(document.getElementById('aircon').value) || 0,
        facility: parseFloat(document.getElementById('facility').value) || 0,
        islandDays: document.getElementById('islandWork').checked ? (parseFloat(document.getElementById('islandDays').value) || 0) : 0,
        includeLaborCost: document.getElementById('includeLaborCost').checked
    };

    // í…Œì´ë¸” ì—…ë°ì´íŠ¸
    updateEstimateTable(quantities, workDays);
}

// ê²¬ì  í…Œì´ë¸” ì—…ë°ì´íŠ¸
function updateEstimateTable(quantities, workDays) {
    const tableBody = document.getElementById('estimateTableBody');
    tableBody.innerHTML = '';
    
    let totalAmount = 0;
    
    // í•­ëª©ë³„ ê³„ì‚° ë° í…Œì´ë¸” í–‰ ì¶”ê°€
    const items = [
        { name: 'ì² ê±°', key: 'demolition', unit: 'í‰', price: pricing.demolition, quantity: quantities.demolition },
        { name: 'ëª©ê³µ', key: 'carpentry', unit: 'í‰', price: pricing.carpentry, quantity: quantities.carpentry },
        { name: 'ì „ê¸°ê³µì‚¬', key: 'electrical', unit: 'í‰', price: pricing.electrical, quantity: quantities.electrical },
        { name: 'ë„ë°°', key: 'wallpaper', unit: 'ê°œ', price: pricing.wallpaper, quantity: quantities.wallpaper },
        { name: 'ìƒ·ì‹œ', key: 'window', unit: 'ê°œ', price: pricing.window, quantity: quantities.window },
        { name: 'ì¡°ëª…', key: 'lighting', unit: 'ê°œ', price: pricing.lighting, quantity: quantities.lighting },
        { name: 'ëª°ë”©', key: 'molding', unit: 'm', price: pricing.molding, quantity: quantities.molding },
        { name: 'ë°”ë‹¥ì¬', key: 'flooring', unit: 'í‰', price: pricing.flooring, quantity: quantities.flooring },
        { name: 'ë¬¸êµì²´', key: 'door', unit: 'ê°œ', price: pricing.door, quantity: quantities.door },
        { name: 'ìš•ì‹¤', key: 'bathroom', unit: 'ê°œ', price: pricing.bathroom, quantity: quantities.bathroom },
        { name: 'ì—ì–´ì»¨', key: 'aircon', unit: 'ê°œ', price: pricing.aircon, quantity: quantities.aircon },
        { name: 'ì„¤ë¹„', key: 'facility', unit: 'ê°œ', price: pricing.facility, quantity: quantities.facility }
    ];

    // ì¼ë°˜ í•­ëª©ë“¤ ì¶”ê°€
    items.forEach(item => {
        if (item.quantity > 0) {
            const amount = item.price * item.quantity;
            totalAmount += amount;
            addTableRow(item.name, formatCurrency(item.price), `${item.quantity} ${item.unit}`, formatCurrency(amount));
        }
    });

    // ì„¬ ê³µì‚¬ ì¶”ê°€
    if (quantities.islandDays > 0) {
        const islandAmount = pricing.island * quantities.islandDays;
        totalAmount += islandAmount;
        addTableRow('ì„¬ ê³µì‚¬', formatCurrency(pricing.island), `${quantities.islandDays} ì¼`, formatCurrency(islandAmount));
    }

    // ê¸°ë³¸ ì¸ê±´ë¹„ ì¶”ê°€
    if (quantities.includeLaborCost && workDays > 0) {
        const laborAmount = pricing.labor * workDays;
        totalAmount += laborAmount;
        addTableRow('ê¸°ë³¸ ì¸ê±´ë¹„', formatCurrency(pricing.labor), `${workDays} ì¼`, formatCurrency(laborAmount));
    }

    // ì´í•©ê³„ ì—…ë°ì´íŠ¸
    document.getElementById('totalAmount').innerHTML = `<strong>${formatCurrency(totalAmount)}</strong>`;
}

// í…Œì´ë¸” í–‰ ì¶”ê°€ í•¨ìˆ˜
function addTableRow(name, price, quantity, amount) {
    const tableBody = document.getElementById('estimateTableBody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${name}</td>
        <td>${price}</td>
        <td>${quantity}</td>
        <td>${amount}</td>
    `;
    tableBody.appendChild(row);
}

// í†µí™” í¬ë§· í•¨ìˆ˜
function formatCurrency(amount) {
    return new Intl.NumberFormat('ko-KR', {
        style: 'currency',
        currency: 'KRW',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// ê´€ë¦¬ì íŒ¨ë„ ì—´ê¸°
function openAdminPanel() {
    const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (password === adminPassword) {
        document.getElementById('adminPanel').style.display = 'flex';
        loadAdminPricing();
    } else if (password !== null) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
}

// ê´€ë¦¬ì íŒ¨ë„ ë‹«ê¸°
function closeAdminPanel() {
    document.getElementById('adminPanel').style.display = 'none';
}

// ë‹¨ê°€ ì €ì¥
function savePricing() {
    pricing.demolition = parseFloat(document.getElementById('admin-demolition').value) || 0;
    pricing.carpentry = parseFloat(document.getElementById('admin-carpentry').value) || 0;
    pricing.electrical = parseFloat(document.getElementById('admin-electrical').value) || 0;
    pricing.wallpaper = parseFloat(document.getElementById('admin-wallpaper').value) || 0;
    pricing.window = parseFloat(document.getElementById('admin-window').value) || 0;
    pricing.lighting = parseFloat(document.getElementById('admin-lighting').value) || 0;
    pricing.molding = parseFloat(document.getElementById('admin-molding').value) || 0;
    pricing.flooring = parseFloat(document.getElementById('admin-flooring').value) || 0;
    pricing.door = parseFloat(document.getElementById('admin-door').value) || 0;
    pricing.bathroom = parseFloat(document.getElementById('admin-bathroom').value) || 0;
    pricing.aircon = parseFloat(document.getElementById('admin-aircon').value) || 0;
    pricing.facility = parseFloat(document.getElementById('admin-facility').value) || 0;
    pricing.island = parseFloat(document.getElementById('admin-island').value) || 0;
    pricing.labor = parseFloat(document.getElementById('admin-labor').value) || 0;

    // localStorageì— ì €ì¥
    localStorage.setItem('interiorPricing', JSON.stringify(pricing));
    
    alert('ë‹¨ê°€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    calculateEstimate(); // ì¦‰ì‹œ ê²¬ì  ì¬ê³„ì‚°
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
function changePassword() {
    const currentPassword = prompt('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (currentPassword !== adminPassword) {
        alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    const newPassword = prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
    if (!newPassword) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    const confirmPassword = prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:');
    if (newPassword !== confirmPassword) {
        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }

    adminPassword = newPassword;
    localStorage.setItem('adminPassword', adminPassword);
    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// ê²¬ì ì„œ ë³µì‚¬
function copyEstimate() {
    const table = document.getElementById('estimateTable');
    const totalAmount = document.getElementById('totalAmount').textContent;
    
    let copyText = 'ì¸í…Œë¦¬ì–´ ê²¬ì ì„œ\n\n';
    copyText += 'í•­ëª©\të‹¨ê°€\tìˆ˜ëŸ‰\tê¸ˆì•¡\n';
    copyText += 'â”€'.repeat(50) + '\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        copyText += `${cells[0].textContent}\t${cells[1].textContent}\t${cells[2].textContent}\t${cells[3].textContent}\n`;
    });
    
    copyText += 'â”€'.repeat(50) + '\n';
    copyText += `ì´ í•©ê³„: ${totalAmount}\n`;
    copyText += `\nê²¬ì  ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}`;

    navigator.clipboard.writeText(copyText).then(() => {
        alert('ê²¬ì ì„œê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }).catch(() => {
        alert('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì¸ì‡„
function printEstimate() {
    const printWindow = window.open('', '_blank');
    const table = document.getElementById('estimateTable').outerHTML;
    const totalAmount = document.getElementById('totalAmount').textContent;
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>ì¸í…Œë¦¬ì–´ ê²¬ì ì„œ</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { text-align: center; color: #333; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                th { background-color: #f2f2f2; }
                .total-row { background-color: #e8f5e8; font-weight: bold; }
                .date { text-align: right; margin-top: 20px; }
            </style>
        </head>
        <body>
            <h1>ğŸ  ì¸í…Œë¦¬ì–´ ê²¬ì ì„œ</h1>
            ${table}
            <div class="date">ê²¬ì  ì‘ì„±ì¼: ${new Date().toLocaleDateString('ko-KR')}</div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
}

// í´ë¦­ ì™¸ë¶€ ì˜ì—­ í´ë¦­ì‹œ ê´€ë¦¬ì íŒ¨ë„ ë‹«ê¸°
document.getElementById('adminPanel').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAdminPanel();
    }
});
